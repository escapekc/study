<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级专注力计时器 (最终修复版)</title>
    <style>
        /* CSS样式保持不变，此处省略 */
        :root{--bg-color:#121212;--primary-text-color:#E0E0E0;--secondary-text-color:#B0B0B0;--accent-color:#4CAF50;--panel-bg-color:#1E1E1E;--border-color:#333;--danger-color:#F44336;}*{margin:0;padding:0;box-sizing:border-box;}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background-color:var(--bg-color);color:var(--primary-text-color);display:flex;justify-content:center;align-items:center;min-height:100vh;text-align:center;padding:15px;}.app-container{width:100%;max-width:600px;display:flex;flex-direction:column;gap:25px;}.timer-display-area{display:flex;flex-direction:column;align-items:center;justify-content:center;}#timer-display{font-size:clamp(6rem, 25vw, 12rem);font-weight:bold;line-height:1;transition:opacity .3s ease;}#timer-display.hidden{opacity:0;}#status-message,#round-indicator{font-size:clamp(1.2rem, 4vw, 1.8rem);color:var(--secondary-text-color);min-height:2.5rem;padding:0 10px;}#motivation-quote{font-size:clamp(1rem, 3.5vw, 1.5rem);color:var(--accent-color);font-style:italic;min-height:60px;display:flex;align-items:center;justify-content:center;padding:0 15px;}#settings-panel{background-color:var(--panel-bg-color);padding:20px;border-radius:12px;border:1px solid var(--border-color);display:flex;flex-direction:column;gap:15px;transition:opacity .5s,transform .5s;}.setting-item{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}.setting-item label{font-size:1rem;text-align:left;flex-shrink:0;}.setting-item input[type=number]{width:70px;padding:8px;background-color:var(--bg-color);color:var(--primary-text-color);border:1px solid var(--border-color);border-radius:6px;text-align:center;font-size:1rem;}.setting-item input[type=number]::-webkit-inner-spin-button,.setting-item input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}.setting-item input[type=number]{-moz-appearance:textfield;}.setting-item.checkbox-item{justify-content:flex-start;gap:15px;}input[type=checkbox]{width:20px;height:20px;accent-color:var(--accent-color);}#controls{display:flex;justify-content:center;gap:15px;flex-wrap:wrap;}.control-btn{padding:12px 25px;font-size:1.1rem;border:none;border-radius:8px;cursor:pointer;transition:background-color .3s,transform .1s;color:#fff;font-weight:bold;}#start-btn{background-color:var(--accent-color);}#start-btn:hover{background-color:#5cb85c;}#pause-btn{background-color:#f0ad4e;display:none;}#pause-btn:hover{background-color:#eea236;}#reset-btn{background-color:var(--danger-color);display:none;}#reset-btn:hover{background-color:#d43f3a;}.control-btn:active{transform:scale(.95);}
    </style>
</head>
<body>
    <!-- HTML结构保持不变 -->
    <div class="app-container">
        <!-- ... (和之前一样) ... -->
    </div>
    
    <!-- 关键改动: 换回稳定、可靠的外部音频链接 -->
    <audio id="high-pitch-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3" preload="auto"></audio>
    <audio id="low-pitch-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // 获取所有 DOM 元素
            const timerDisplay = document.getElementById('timer-display');
            const statusMessage = document.getElementById('status-message');
            const roundIndicator = document.getElementById('round-indicator');
            const motivationQuote = document.getElementById('motivation-quote');
            const settingsPanel = document.getElementById('settings-panel');
            const startBtn = document.getElementById('start-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const resetBtn = document.getElementById('reset-btn');
            const highPitchSound = document.getElementById('high-pitch-sound');
            const lowPitchSound = document.getElementById('low-pitch-sound');
            const workDurationInput = document.getElementById('work-duration');
            const randomMinInput = document.getElementById('random-min');
            const randomMaxInput = document.getElementById('random-max');
            const shortBreakInput = document.getElementById('short-break');
            const totalRoundsInput = document.getElementById('total-rounds');
            const longBreakInput = document.getElementById('long-break');
            const showTimerToggle = document.getElementById('show-timer-toggle');

            // 定义状态变量和函数
            let mainInterval = null; let currentState = 'idle'; let targetTime = 0; let timePaused = 0; let currentRound = 1; let nextPingTime = 0;
            let isAudioUnlocked = false;
            const motivationalQuotes = ["休息一下，是为了走更远的路。闭上眼，深呼吸。", "放下手机，让大脑回归宁静。", "此刻，世界与你无关。只关注自己的呼吸。", "冥想片刻，给思绪一次清扫。", "听一首舒缓的音乐，让心灵去旅行。", "拉伸一下身体，活动一下筋骨。", "成功的路上，休息也是一种策略。", "不要被短暂的娱乐绑架，你的目标更重要。", "每一次专注，都是一次自我超越。", "闭目养神，积蓄下一次爆发的力量。", "远离屏幕，看看窗外的风景。", "一杯温水，一份宁静。", "坚持就是胜利，但聪明的坚持包含休息。"];

            function unlockAudio() {
                if (isAudioUnlocked || !highPitchSound || !lowPitchSound) return;
                
                console.log("Attempting to unlock audio...");
                try {
                    highPitchSound.volume = 0; // Play silently
                    const highPromise = highPitchSound.play();
                    
                    lowPitchSound.volume = 0; // Play silently
                    const lowPromise = lowPitchSound.play();
                    
                    // Once played (even silently), pause them and reset volume.
                    if (highPromise !== undefined) {
                        highPromise.then(() => {
                            highPitchSound.pause();
                            highPitchSound.volume = 1;
                        }).catch(() => {});
                    }
                    if (lowPromise !== undefined) {
                        lowPromise.then(() => {
                            lowPitchSound.pause();
                            lowPitchSound.volume = 1;
                        }).catch(() => {});
                    }

                    isAudioUnlocked = true;
                    console.log("Audio unlocked successfully.");
                } catch (e) {
                    console.error("Error during audio unlock:", e);
                }
            }

            function playSound(soundElement) {
                if (!soundElement) {
                    console.error("playSound called with a null element.");
                    return;
                }
                soundElement.currentTime = 0;
                soundElement.volume = 1; // Ensure volume is full
                const playPromise = soundElement.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error(`Error playing sound: ${soundElement.id}`, error);
                    });
                }
            }
            
            // --- 核心逻辑函数 (这部分无需改动) ---
            function getSettings() { const workDuration = parseInt(workDurationInput.value) * 60; const randomMin = parseInt(randomMinInput.value) * 60; const randomMax = parseInt(randomMaxInput.value) * 60; return { workDuration: isNaN(workDuration) || workDuration < 60 ? 100 * 60 : workDuration, randomMin: isNaN(randomMin) || randomMin < 1 ? 2 * 60 : randomMin, randomMax: isNaN(randomMax) || randomMax < randomMin ? 5 * 60 : randomMax, shortBreak: parseInt(shortBreakInput.value) || 10, totalRounds: parseInt(totalRoundsInput.value) || 1, longBreak: parseInt(longBreakInput.value) * 60 || 20 * 60, }; }
            function displayTime(seconds) { const mins = Math.floor(seconds / 60); const secs = seconds % 60; timerDisplay.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; }
            function updateInitialDisplay() { const settings = getSettings(); displayTime(settings.workDuration); }
            function toggleControls(isRunning, isPaused = false) { if (isRunning) { startBtn.style.display = 'none'; pauseBtn.style.display = 'inline-block'; resetBtn.style.display = 'inline-block'; settingsPanel.style.opacity = '0'; settingsPanel.style.pointerEvents = 'none'; settingsPanel.style.transform = 'translateY(-20px)'; } else if (isPaused) { startBtn.style.display = 'inline-block'; startBtn.textContent = '继续'; pauseBtn.style.display = 'none'; } else { startBtn.style.display = 'inline-block'; startBtn.textContent = '开始'; pauseBtn.style.display = 'none'; resetBtn.style.display = 'none'; settingsPanel.style.opacity = '1'; settingsPanel.style.pointerEvents = 'auto'; settingsPanel.style.transform = 'translateY(0)'; } }
            function getStatusText(state) { switch(state) { case 'working': return '专注中...'; case 'short_break': return '间歇休息'; case 'long_break': return '放松一下'; default: return ''; } }
            function tick() { let remainingSeconds = Math.round((targetTime - Date.now()) / 1000); if(remainingSeconds < 0) remainingSeconds = 0; displayTime(remainingSeconds); if (currentState === 'working' && nextPingTime > 0 && Date.now() >= nextPingTime) { triggerRandomPing(); return; } if (remainingSeconds <= 0) { handleStateTransition(); } }
            function triggerRandomPing() { clearInterval(mainInterval); nextPingTime = 0; const remainingWorkTime = targetTime - Date.now(); pauseBtn.dataset.remainingWorkTime = remainingWorkTime; playSound(lowPitchSound); startShortBreak(); }
            function scheduleRandomPing() { const settings = getSettings(); let remainingSeconds = Math.round((targetTime - Date.now()) / 1000); const randomDelaySeconds = Math.floor(Math.random() * (settings.randomMax - settings.randomMin + 1)) + settings.randomMin; if (randomDelaySeconds < remainingSeconds) { nextPingTime = Date.now() + randomDelaySeconds * 1000; } else { nextPingTime = 0; } }
            function pauseTimer() { clearInterval(mainInterval); timePaused = Date.now(); pauseBtn.dataset.lastState = currentState; currentState = 'paused'; statusMessage.textContent = "已暂停"; toggleControls(false, true); }
            function resumeTimer() { const pauseDuration = Date.now() - timePaused; targetTime += pauseDuration; if (nextPingTime > 0) { nextPingTime += pauseDuration; } currentState = pauseBtn.dataset.lastState; statusMessage.textContent = getStatusText(currentState); mainInterval = setInterval(tick, 250); toggleControls(true); }
            function handleStateTransition() { clearInterval(mainInterval); playSound(highPitchSound); switch (currentState) { case 'working': if (currentRound < getSettings().totalRounds) { startLongBreak(); } else { finishAllSessions(); } break; case 'short_break': resumeWorkSession(); break; case 'long_break': currentRound++; startWorkSession(); break; } }
            function resumeWorkSession() { currentState = 'working'; const remainingWorkTime = parseInt(pauseBtn.dataset.remainingWorkTime, 10); targetTime = Date.now() + remainingWorkTime; statusMessage.textContent = getStatusText(currentState); scheduleRandomPing(); mainInterval = setInterval(tick, 250); }
            function startWorkSession() { const settings = getSettings(); currentState = 'working'; targetTime = Date.now() + settings.workDuration * 1000; statusMessage.textContent = getStatusText(currentState); roundIndicator.textContent = `第 ${currentRound} / ${settings.totalRounds} 轮`; motivationQuote.textContent = ""; playSound(highPitchSound); scheduleRandomPing(); mainInterval = setInterval(tick, 250); }
            function startShortBreak() { currentState = 'short_break'; targetTime = Date.now() + getSettings().shortBreak * 1000; statusMessage.textContent = getStatusText(currentState); mainInterval = setInterval(tick, 250); }
            function startLongBreak() { const settings = getSettings(); if (settings.longBreak <= 0) { currentRound++; startWorkSession(); return; } currentState = 'long_break'; targetTime = Date.now() + settings.longBreak * 1000; statusMessage.textContent = getStatusText(currentState); motivationQuote.textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]; mainInterval = setInterval(tick, 250); }
            function resetTimer() { clearInterval(mainInterval); mainInterval = null; currentState = 'idle'; currentRound = 1; isAudioUnlocked = false; updateInitialDisplay(); statusMessage.textContent = "请设置参数后开始"; roundIndicator.textContent = ""; motivationQuote.textContent = ""; toggleControls(false); }
            function finishAllSessions() { statusMessage.textContent = "恭喜！所有轮次已完成！"; motivationQuote.textContent = "你做到了！给自己一个大大的赞赏！"; roundIndicator.textContent = ""; resetTimer(); }
            function startTimer() { currentState = 'idle'; currentRound = 1; startWorkSession(); toggleControls(true); }

            // --- 绑定事件监听器 ---
            startBtn.addEventListener('click', () => {
                if (!isAudioUnlocked) {
                    unlockAudio();
                }
                if (currentState === 'idle') {
                    startTimer();
                } else if (currentState === 'paused') {
                    resumeTimer();
                }
            });

            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', resetTimer);
            showTimerToggle.addEventListener('change', () => { timerDisplay.classList.toggle('hidden', !showTimerToggle.checked); });
            document.querySelectorAll('#settings-panel input').forEach(input => {
                input.addEventListener('input', () => { if (currentState === 'idle') { updateInitialDisplay(); } });
            });
            
            // --- 初始化页面显示 ---
            updateInitialDisplay();
        });
    </script>
</body>
</html>
